{"pageProps":{"postData":{"id":"with_rollup_ambiguous","contentHtml":"<h2>結論</h2>\n<p>GROUP BY hoge.id WITH ROLLUP のときに WITH ROLLUP のレコードでは hoge.name などを正しく取得できないケースがある。</p>\n<h2>前提</h2>\n<p><strong>MySQL バージョン: 5.6 での実行</strong></p>\n<p>ユーザー(users)</p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>name</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>田中</td>\n</tr>\n<tr>\n<td>2</td>\n<td>佐藤</td>\n</tr>\n</tbody>\n</table>\n<p>ユーザーの決済(transactions)</p>\n<table>\n<thead>\n<tr>\n<th>user_id</th>\n<th>price</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1000</td>\n</tr>\n<tr>\n<td>1</td>\n<td>2000</td>\n</tr>\n<tr>\n<td>2</td>\n<td>3000</td>\n</tr>\n<tr>\n<td>2</td>\n<td>4000</td>\n</tr>\n</tbody>\n</table>\n<p>上記のような2テーブルがあり、 ユーザーごとの合計決済額と全てのユーザーの合計決済額を出したいとする。<br>\nそこで下記のようなSQLを実行する。</p>\n<pre><code>SELECT \nu.id\n, u.name \n, sum(t.price)\nFROM users AS u \nINNER JOIN transactions AS t\nON u.id = t.user_id\nGROUP BY u.id WTIH ROLLUP\n</code></pre>\n<p>すると、WITH ROLLUP の結果として出力されるレコードで正しく<code>u.name</code>が表示されない。<br>\n(<code>u.id</code>はNULLで出力されるが<code>u.name</code>はランダムで<code>u.name</code>のいずれかが出力される)</p>\n<p>WITH ROLLUP のレコードは 全てまとめたものになっており、単一の値でないため hoge.name がランダムに取得されるため。</p>\n<p>例えば、WITH ROLLUP のレコードにおいては<code>u.name</code>のカラムを<code>合計</code>という値で表示したい場合 下記のように記載する。</p>\n<pre><code>if(count(distinct mu.id) > 1,\"合計\", u.name) \n</code></pre>\n<p>参考: <a href=\"https://stackoverflow.com/questions/42223119/if-cases-broken-when-using-rollup\">https://stackoverflow.com/questions/42223119/if-cases-broken-when-using-rollup</a></p>\n","title":"SQL で GROUP BY WITH ROLLUP した際に正しく値を取得できないケース","date":"2021-09-10"}},"__N_SSG":true}