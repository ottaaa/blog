{"pageProps":{"postData":{"id":"with_rollup_ambiguous","contentHtml":"<h2>結論</h2>\n<p>GROUP BY hoge.id WITH ROLLUP のときに\nWITH ROLLUP のレコードでは hoge.name などを正しく取得できないケースがある。</p>\n<h2>前提</h2>\n<p><strong>MySQL バージョン: 5.6 での実行</strong></p>\n<p>ユーザー(users)</p>\n<p>|id|name|\n|----|----|\n|1|田中|\n|2|佐藤|</p>\n<p>ユーザーの決済(transactions)</p>\n<p>|user_id|price|\n|----|----|\n|1|1000|\n|1|2000|\n|2|3000|\n|2|4000|</p>\n<p>上記のような2テーブルがあり、 ユーザーごとの合計決済額と全てのユーザーの合計決済額を出したいとする。<br>\nそこで下記のようなSQLを実行する。</p>\n<pre><code>SELECT \nu.id\n, u.name \n, sum(t.price)\nFROM users AS u \nINNER JOIN transactions AS t\nON u.id = t.user_id\nGROUP BY u.id WTIH ROLLUP\n</code></pre>\n<p>すると、WITH ROLLUP の結果として出力されるレコードで正しく<code>u.name</code>が表示されない。<br>\n(<code>u.id</code>はNULLで出力されるが<code>u.name</code>はランダムで<code>u.name</code>のいずれかが出力される)</p>\n<p>WITH ROLLUP のレコードは 全てまとめたものになっており、単一の値でないため\nhoge.name がランダムに取得されるため。</p>\n<p>例えば、WITH ROLLUP のレコードにおいては<code>u.name</code>のカラムを<code>合計</code>という値で表示したい場合\n下記のように記載する。</p>\n<pre><code>if(count(distinct mu.id) > 1,\"合計\", u.name) \n</code></pre>\n<p>参考: https://stackoverflow.com/questions/42223119/if-cases-broken-when-using-rollup</p>\n","title":"SQL で GROUP BY WITH ROLLUP した際に正しく値を取得できないケース","date":"2021-09-10"}},"__N_SSG":true}