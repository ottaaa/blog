<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="oootta blog"/><meta property="og:image" content="https://og-image.vercel.app/oootta%20blog.png?theme=light&amp;md=0&amp;fontSize=75px&amp;images=https%3A%2F%2Fassets.zeit.co%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta name="og:title" content="oootta blog"/><meta name="twitter:card" content="summary_large_image"/><title>SQL で GROUP BY WITH ROLLUP した際に正しく値を取得できないケース</title><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/d956bfbeac7a7df3d68f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d956bfbeac7a7df3d68f.css" data-n-g=""/><link rel="preload" href="/_next/static/css/960c0da36687fee2a3db.css" as="style"/><link rel="stylesheet" href="/_next/static/css/960c0da36687fee2a3db.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-fb76148cfcfb42ca18eb.js" defer=""></script><script src="/_next/static/chunks/framework-1a85486469afb3278dba.js" defer=""></script><script src="/_next/static/chunks/main-8d15616dad332ac01c02.js" defer=""></script><script src="/_next/static/chunks/pages/_app-dbfb39d2c6bc7bbd7b3a.js" defer=""></script><script src="/_next/static/chunks/941-b533ee67c058e7df0ccc.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-fb5f99cd10b4fa6552f1.js" defer=""></script><script src="/_next/static/LrMQZLDD09F6-cPP8ppVZ/_buildManifest.js" defer=""></script><script src="/_next/static/LrMQZLDD09F6-cPP8ppVZ/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="layout_container__2t4v2"><main><article><h1 class="utils_headingXl__1XecN">SQL で GROUP BY WITH ROLLUP した際に正しく値を取得できないケース</h1><div class="utils_lightText__12Ckm"><time dateTime="2021-09-10">September 10, 2021</time></div><div class="markdown-body"><h2>結論</h2>
<p>GROUP BY hoge.id WITH ROLLUP のときに WITH ROLLUP のレコードでは hoge.name などを正しく取得できないケースがある。</p>
<h2>前提</h2>
<p><strong>MySQL バージョン: 5.6 での実行</strong></p>
<p>ユーザー(users)</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>田中</td>
</tr>
<tr>
<td>2</td>
<td>佐藤</td>
</tr>
</tbody>
</table>
<p>ユーザーの決済(transactions)</p>
<table>
<thead>
<tr>
<th>user_id</th>
<th>price</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1000</td>
</tr>
<tr>
<td>1</td>
<td>2000</td>
</tr>
<tr>
<td>2</td>
<td>3000</td>
</tr>
<tr>
<td>2</td>
<td>4000</td>
</tr>
</tbody>
</table>
<p>上記のような2テーブルがあり、 ユーザーごとの合計決済額と全てのユーザーの合計決済額を出したいとする。<br>
そこで下記のようなSQLを実行する。</p>
<pre><code>SELECT 
u.id
, u.name 
, sum(t.price)
FROM users AS u 
INNER JOIN transactions AS t
ON u.id = t.user_id
GROUP BY u.id WTIH ROLLUP
</code></pre>
<p>すると、WITH ROLLUP の結果として出力されるレコードで正しく<code>u.name</code>が表示されない。<br>
(<code>u.id</code>はNULLで出力されるが<code>u.name</code>はランダムで<code>u.name</code>のいずれかが出力される)</p>
<p>WITH ROLLUP のレコードは 全てまとめたものになっており、単一の値でないため hoge.name がランダムに取得されるため。</p>
<p>例えば、WITH ROLLUP のレコードにおいては<code>u.name</code>のカラムを<code>合計</code>という値で表示したい場合 下記のように記載する。</p>
<pre><code>if(count(distinct mu.id) > 1,"合計", u.name) 
</code></pre>
<p>参考: <a href="https://stackoverflow.com/questions/42223119/if-cases-broken-when-using-rollup">https://stackoverflow.com/questions/42223119/if-cases-broken-when-using-rollup</a></p>
</div></article></main><div class="layout_backToHome__1vZsp"><a href="/">← 記事一覧へ</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"with_rollup_ambiguous","contentHtml":"\u003ch2\u003e結論\u003c/h2\u003e\n\u003cp\u003eGROUP BY hoge.id WITH ROLLUP のときに WITH ROLLUP のレコードでは hoge.name などを正しく取得できないケースがある。\u003c/p\u003e\n\u003ch2\u003e前提\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eMySQL バージョン: 5.6 での実行\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eユーザー(users)\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eid\u003c/th\u003e\n\u003cth\u003ename\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e田中\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e2\u003c/td\u003e\n\u003ctd\u003e佐藤\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eユーザーの決済(transactions)\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003euser_id\u003c/th\u003e\n\u003cth\u003eprice\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e1000\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003ctd\u003e2000\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e2\u003c/td\u003e\n\u003ctd\u003e3000\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e2\u003c/td\u003e\n\u003ctd\u003e4000\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e上記のような2テーブルがあり、 ユーザーごとの合計決済額と全てのユーザーの合計決済額を出したいとする。\u003cbr\u003e\nそこで下記のようなSQLを実行する。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eSELECT \nu.id\n, u.name \n, sum(t.price)\nFROM users AS u \nINNER JOIN transactions AS t\nON u.id = t.user_id\nGROUP BY u.id WTIH ROLLUP\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eすると、WITH ROLLUP の結果として出力されるレコードで正しく\u003ccode\u003eu.name\u003c/code\u003eが表示されない。\u003cbr\u003e\n(\u003ccode\u003eu.id\u003c/code\u003eはNULLで出力されるが\u003ccode\u003eu.name\u003c/code\u003eはランダムで\u003ccode\u003eu.name\u003c/code\u003eのいずれかが出力される)\u003c/p\u003e\n\u003cp\u003eWITH ROLLUP のレコードは 全てまとめたものになっており、単一の値でないため hoge.name がランダムに取得されるため。\u003c/p\u003e\n\u003cp\u003e例えば、WITH ROLLUP のレコードにおいては\u003ccode\u003eu.name\u003c/code\u003eのカラムを\u003ccode\u003e合計\u003c/code\u003eという値で表示したい場合 下記のように記載する。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eif(count(distinct mu.id) \u003e 1,\"合計\", u.name) \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e参考: \u003ca href=\"https://stackoverflow.com/questions/42223119/if-cases-broken-when-using-rollup\"\u003ehttps://stackoverflow.com/questions/42223119/if-cases-broken-when-using-rollup\u003c/a\u003e\u003c/p\u003e\n","title":"SQL で GROUP BY WITH ROLLUP した際に正しく値を取得できないケース","date":"2021-09-10"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"with_rollup_ambiguous"},"buildId":"LrMQZLDD09F6-cPP8ppVZ","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>